<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞—Ä–µ–Ω–¥—ã</title>

<style>
:root {
  --bg:#f6f7fb;--card:#fff;--text:#1f2937;--muted:#6b7280;
  --border:#e5e7eb;--accent:#2563eb;--accent-soft:#eff6ff;
  --radius:14px;
}
*{box-sizing:border-box}
body{margin:0;padding:24px;font-family:system-ui;background:var(--bg);color:var(--text)}
h1,h3{margin:0 0 12px} h3{margin-top:32px}
.small{font-size:.85em;color:var(--muted)}

.controls{
  background:var(--card);border:1px solid var(--border);
  border-radius:var(--radius);padding:16px;margin-bottom:20px;
  display:flex;flex-wrap:wrap;gap:12px;align-items:center
}
input,button{
  padding:8px 10px;border-radius:10px;
  border:1px solid var(--border);font-size:.95em
}
button{background:var(--accent);color:#fff;border:none;cursor:pointer}

.totals{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:16px;margin-bottom:16px
}
.card{background:var(--card);border:1px solid var(--border);
  border-radius:var(--radius);padding:16px}
.card .value{font-size:1.4em;font-weight:600}

.top-row{display:flex;gap:12px;overflow-x:auto}
.user{min-width:220px;background:var(--card);border:1px solid var(--border);
  border-radius:var(--radius);padding:12px}

table{width:100%;border-collapse:collapse;background:var(--card);
  border-radius:var(--radius);border:1px solid var(--border)}
thead{background:var(--accent-soft)}
th,td{padding:10px 12px;border-bottom:1px solid var(--border)}

.day-reminders-grid{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
  gap:12px
}
.reminder-card{
  border:1px solid var(--border);border-radius:var(--radius);
  padding:12px;background:var(--card)
}
.reminder-bar{
  height:6px;background:var(--accent-soft);
  border-radius:4px;overflow:hidden;margin-top:6px
}
.reminder-bar span{display:block;height:100%;background:var(--accent)}

footer{margin-top:40px;font-size:.8em;color:var(--muted);text-align:center}
</style>
</head>

<body>

<h1>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞—Ä–µ–Ω–¥—ã</h1>

<div class="controls">
–î–∞—Ç–∞ <input type="date" id="date">
–û—Ç <input type="date" id="range_start">
–î–æ <input type="date" id="range_end">
USD/RUB <input id="usd_rub" value="80" size="4">
USD/UAH <input id="usd_uah" value="42" size="4">
<button id="refresh">–û–±–Ω–æ–≤–∏—Ç—å</button>
<button id="range_btn">–û—Ç—á–µ—Ç –ø–æ –¥–Ω—è–º</button>
</div>

<div class="totals">
<div class="card"><div class="small">RUB</div><div id="total_rub" class="value">0 ‚ÇΩ</div></div>
<div class="card"><div class="small">UAH</div><div id="total_uah" class="value">0 ‚Ç¥</div></div>
<div class="card"><div class="small">‚âà USD</div><div id="total_usd" class="value">0 $</div></div>
</div>

<div id="overall" class="small"></div>

<h3>üèÜ –¢–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
<div class="top-row" id="top_row"></div>

<h3>üîî –ö–æ–º—É –Ω–∞–ø–æ–º–Ω–∏—Ç—å –Ω–∞ –¥–µ–Ω—å</h3>
<div class="card">
<div style="margin-bottom:12px">
–î–∞—Ç–∞ <input type="date" id="remind_date">
–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π <input id="remind_per_day" type="number" value="1" min="1" max="5">
–ü–æ—Å–ª–µ–¥–Ω–∏—Ö N <input id="remind_last_n" type="number" value="50">
–°–æ–Ω —Å <input id="remind_sleep_start" type="number" value="0" min="0" max="23">
–¥–æ <input id="remind_sleep_end" type="number" value="6" min="0" max="23">
<button id="day_reminders_btn">–ü–æ–∫–∞–∑–∞—Ç—å</button>
</div>
<div id="day_reminders" class="day-reminders-grid"></div>
</div>

<h3>üìÖ –û—Ç—á–µ—Ç –ø–æ –¥–Ω—è–º</h3>
<table>
<thead><tr><th>–î–∞—Ç–∞</th><th>RUB</th><th>UAH</th><th>‚âà USD</th></tr></thead>
<tbody id="range_body"></tbody>
</table>

<h3>üí∞ –ó–∞—Ä–ø–ª–∞—Ç–∞</h3>
<button id="salary_btn">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
<div id="salary_result" class="small"></div>

<footer>database.json ¬∑ API 127.0.0.1:8001</footer>

<script>
const API='http://127.0.0.1:8001';
const iso=d=>d.toISOString().slice(0,10);
const round=v=>Math.round((v+1e-9)*100)/100;

async function render(){
const day=date.value||iso(new Date());
const usdRub=+usd_rub.value||80,usdUah=+usd_uah.value||42;

const t=await fetch(`${API}/stats/day?day=${day}`).then(r=>r.json());
total_rub.textContent=round(t.totals.rub)+' ‚ÇΩ';
total_uah.textContent=round(t.totals.uah)+' ‚Ç¥';
total_usd.textContent=round(t.totals.rub/usdRub+t.totals.uah/usdUah)+' $';

const top=await fetch(`${API}/stats/top?n=20`).then(r=>r.json());
top_row.innerHTML='';
for(const u of top.top){
const d=document.createElement('div');d.className='user';
d.innerHTML=`<strong>${u.user}</strong>
<div class="small">${u.total_rub_raw} ‚ÇΩ + ${u.total_uah_raw} ‚Ç¥</div>
<div class="small">–û–ø–µ—Ä–∞—Ü–∏–π: ${u.count}</div>`;
top_row.appendChild(d);
}
}

async function renderRange(){
const s=range_start.value,e=range_end.value||s;
if(!s)return;
const usdRub=+usd_rub.value||80,usdUah=+usd_uah.value||42;
const j=await fetch(`${API}/stats/range?start=${s}&end=${e}`).then(r=>r.json());
range_body.innerHTML='';
for(const k of Object.keys(j.by_day||{}).sort()){
const d=j.by_day[k];
range_body.innerHTML+=`<tr><td>${k}</td><td>${d.rub} ‚ÇΩ</td><td>${d.uah} ‚Ç¥</td><td>${round(d.rub/usdRub+d.uah/usdUah)} $</td></tr>`;
}
}

async function renderSalary(){
const s=range_start.value,e=range_end.value||s;
if(!s)return;
const j=await fetch(`${API}/stats/extremes?start=${s}&end=${e}`).then(r=>r.json());
if(!j.best){salary_result.textContent='–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';return}
salary_result.innerHTML=
`–õ—É—á—à–∏–π: ${j.best.date} ‚âà ${j.best.usd} $<br>
–•—É–¥—à–∏–π: ${j.worst.date} ‚âà ${j.worst.usd} $`;
}

async function loadDayReminders(){
const q=`day=${remind_date.value}&last_n=${remind_last_n.value}&reminders=${remind_per_day.value}&sleep_start=${remind_sleep_start.value}&sleep_end=${remind_sleep_end.value}`;
const j=await fetch(`${API}/stats/reminders?${q}`).then(r=>r.json());
day_reminders.innerHTML='';
if(!j.result?.length){day_reminders.innerHTML='<div class="small">–ù–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π</div>';return}
const max=Math.max(...j.result.map(u=>u.reminders.length),1);
for(const u of j.result){
const c=u.reminders.length;
day_reminders.innerHTML+=`
<div class="reminder-card">
<strong>${u.user||'–±–µ–∑ username'}</strong>
<div class="small">${u.reminders.map(r=>r.time).join(', ')}</div>
<div class="reminder-bar"><span style="width:${c/max*100}%"></span></div>
</div>`;
}
}

refresh.onclick=render;
range_btn.onclick=renderRange;
salary_btn.onclick=renderSalary;
day_reminders_btn.onclick=loadDayReminders;

date.value=iso(new Date());
range_start.value=iso(new Date(Date.now()-6*86400000));
range_end.value=iso(new Date());
remind_date.value=iso(new Date());

render();renderRange();
</script>
</body>
</html>
